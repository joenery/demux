#!/bin/bash
#

QSUB_PARENT="/gale/netapp/seq2/illumina_runs/.qsub"
BCL_PATH_FILE="bcl_path.txt"

usage() {
echo "Usage: demux-run -s /gale/netapp/seq2/illumina_runs/.samplesheets/180709_K00161_0224_AHVMNJBBXX/SampleSheet_180709_K00161_0224.csv"
echo "-s	path to samplesheet file"
echo "-O	additional bcl2fastq options"
echo "-h	display this help message"
}

while getopts ":s:O:h" opt; do
  case $opt in
    s) 
      SAMPLESHEET_PATH=$OPTARG
      ;;
    O)
      bclopts=$OPTARG
      ;;
    h) 
      usage
      exit 1
      ;;
    \?)
      echo "Invalid option: -$OPTARG"
      usage
      exit 1
      ;;
  esac
done

echo "bclopts: $bclopts"

#generate bcl2fastq command line
bcl2fastq_command_line=$(demux-commandline -s "$SAMPLESHEET_PATH" -O "$bclopts")

#check demux-commandline script exit status
if [ $(echo $?) -eq 1 ] ; then
  echo "$bcl2fastq_command_line"
  exit 1
fi

#parse command line
bcl_path=$(echo $bcl2fastq_command_line \
  | awk '{print $4}')

samplesheet_path=$(echo $bcl2fastq_command_line \
  | awk '{print $6}'

fastq_path=$(echo $bcl2fastq_command_line \
  | awk '{print $8}')

instrument=$(echo $bcl2fastq_command_line \
  | awk -F"/" '{print $NF}' \
  | awk -F"_" '{print $2}')

if [ $instrument == "M00412" ]; then
  qsub_dir=$(echo $bcl2fastq_command_line \
    | awk -F"/" '{print $NF}' \
    | awk -F"_" '{print $4}' \
    | awk -F"-" '{print $NF}')
else
  qsub_dir=$(echo $bcl2fastq_command_line \
    | awk -F"/" '{print $NF}' \
    | awk -F"_" '{print $4}' \
    | awk '{print substr($NF,2,9)}')
fi

qsub_dir+=$(echo $bcl2fastq_command_line \
  | awk -F"/" '{print $NF}' \
  | awk -F"_" '{print substr($NF,3,8)}')

qsub_path="$QSUB_PARENT/$qsub_dir"

mkdir $qsub_path

#write command line for submitting to queue
echo $bcl2fastq_command_line > $qsub_path/commands

cd $qsub_path

echo "Submitting job to queue"
2q

#wait for the fastq directory to be created
until [ -d $fastq_path ]; do 
  sleep 60 ; 
done ; 

#write a file containing bcl_path
echo $bcl_path >> $fastq_path/$BCL_PATH_FILE

node=$(qstat | grep "${qsub_dir:0:10}")

echo "$node" > $qsub_path/node.txt
echo $bcl2fastq_command_line
echo "$qsub_path"
exit 0
