#!/bin/bash
#
QSUB_PARENT="/gale/netapp/seq2/illumina_runs/.qsub"
BCL_PATH_FILE="bcl_path.txt"
SAMPLESHEET_NAME="SampleSheet.csv"
RECIPIENT="jnery@salk.edu"

usage() {
echo "Usage: demux-run -s /gale/netapp/seq2/illumina_runs/.samplesheets/180709_K00161_0224_AHVMNJBBXX/SampleSheet_180709_K00161_0224.csv -O \"-p 16\""
echo "-s	path to samplesheet file"
echo "-O	additional bcl2fastq options"
echo "-h	display this help message"
}

while getopts ":s:O:h" opt; do
  case $opt in
    s) 
      SAMPLESHEET_PATH=$OPTARG
      ;;
    O)
      bclopts=$OPTARG
      ;;
    h) 
      usage
      exit 1
      ;;
    \?)
      echo "Invalid option: -$OPTARG"
      usage
      exit 1
      ;;
  esac
done

echo "bclopts: $bclopts"

#generate bcl2fastq command line
bcl2fastq_command_line=$(demux-commandline -s "$SAMPLESHEET_PATH" -O "$bclopts")

#check demux-commandline script exit status
if [ $(echo $?) -eq 1 ] ; then
  echo "$bcl2fastq_command_line"
  exit 1
fi

echo $bcl2fastq_command_line

#parse command line
bcl_path=$(echo $bcl2fastq_command_line \
  | awk '{print $4}')

samplesheet_path=$(echo $bcl2fastq_command_line \
  | awk '{print $6}')

fastq_path=$(echo $bcl2fastq_command_line \
  | awk '{print $8}')

log_path=$(echo $bcl2fastq_command_line \
  | awk 'END{print $NF}')

instrument=$(echo $bcl2fastq_command_line \
  | awk -F"/" '{print $NF}' \
  | awk -F"_" '{print $2}')

if [ $instrument == "M00412" ]; then
  qsub_dir=$(echo $bcl2fastq_command_line \
    | awk -F"/" '{print $NF}' \
    | awk -F"_" '{print $4}' \
    | awk -F"-" '{print $NF}')
else
  qsub_dir=$(echo $bcl2fastq_command_line \
    | awk -F"/" '{print $NF}' \
    | awk -F"_" '{print $4}' \
    | awk '{print substr($NF,2,9)}')
fi

qsub_dir+=$(echo $bcl2fastq_command_line \
  | awk -F"/" '{print $NF}' \
  | awk -F"_" '{print substr($NF,3,8)}')

qsub_path="$QSUB_PARENT/$qsub_dir"

mkdir $qsub_path

cd $qsub_path

echo $qsub_path

#source ~/.bash_profile in wrapper script
#echo "source /gale/netapp/home/seq/.bash_profile" > $qsub_path/pipeline

#write bcl2fastq_command_line to commands script
echo "$bcl2fastq_command_line" >> $qsub_path/commands

#write qsub commands script that calls pipeline
#echo "bash $qsub_path/pipeline" > $qsub_path/commands

#which bcl2fastq

echo "Submitting job to queue"
2q

qstat

#wait for the fastq directory to be created
until [ -d $fastq_path ]; do 
  echo "*********** DO NOT PRESS CTRL-C! **************"
  echo "Waiting 60 seconds for creation of $fastq_path."
  sleep 60 ; 
done ; 

echo "Writing config files"

#write a file containing bcl_path to the fastq directory
echo $bcl_path >> $fastq_path/$BCL_PATH_FILE

#copy samplesheet to fastq directory
cp $samplesheet_path $fastq_path/$SAMPLESHEET_NAME

#write bcl2fastq_command_line to Unaligned directory
echo "$bcl2fastq_command_line" >> $fastq_path/command_line.txt

#copy xml files to fastq directory
[ -f $bcl_path/RunInfo.xml ] && cp $bcl_path/RunInfo.xml $fastq_path/RunInfo.xml
[ -f $bcl_path/RunParameters.xml ] && cp $bcl_path/RunParameters.xml $fastq_path/RunParameters.xml
[ -f $bcl_path/runParameters.xml ] && cp $bcl_path/runParameters.xml $fastq_path/runParameters.xml 

node=$(qstat | grep "${qsub_dir:0:10}")
#write a file containing the qsub node to the fastq dir
echo "$node" > $fastq_path/node.txt
echo $bcl2fastq_command_line

{
  echo -e "Demux Started. Command-line invocation:" ; \
  echo -e "$bcl2fastq_command_line\n" ; \
} | mailx -s "$bcl_path" "$RECIPIENT"


exit 0
